<!DOCTYPE html>
<html>

  <head>
  
    <title>Microservices with Docker, Flask, and React - Flask Migrate</title>
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="shortcut icon" type="image/png" href="/favicon.ico">
  <link
    rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/css/materialize.min.css"
  >
  <link
    rel="stylesheet"
    href="https://fonts.googleapis.com/icon?family=Material+Icons"
  >
  <link
    rel="stylesheet"
    href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
  >
  <link
    href="//fonts.googleapis.com/css?family=Merriweather:900,900italic,300,300italic"
    rel="stylesheet"
    type="text/css"
  >
  <link
    href="//fonts.googleapis.com/css?family=Lato:900,300"
    rel="stylesheet"
    type="text/css"
  >
  <link
    href="https://fonts.googleapis.com/css?family=Montserrat"
    rel="stylesheet"
    type="text/css"
  >
  <link
    href="//cdn-images.mailchimp.com/embedcode/classic-10_7.css"
    rel="stylesheet"
    type="text/css"
  >
  <link href="/assets/css/styles.css?1515124024017421000" rel="stylesheet">
  <script
    src="//code.jquery.com/jquery-2.2.4.min.js"
    integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
    crossorigin="anonymous"
  ></script>
  <script
    type="text/javascript"
    src="/assets/js/main.js"
  ></script>
  <script
    type="text/javascript"
    src="https://gumroad.com/js/gumroad.js"
  ></script>
</head>


  <body>

    <nav class="indigo darken-4">
  <div class="nav-wrapper">
    <a href="/" class="nav-logo-container left">
      <img
        class="nav-logo" src="/assets/img/test_driven_io_full_logo_white_text.svg" alt="testdriven.io"
      />
    </a>
    <a href="/" class="brand-logo main-brand-logo center show-on-large hide-on-med-and-down">
      Test Driven Development Courses
    </a>
    <!-- <a href="/" class="brand-logo main-brand-logo hide-on-large-only">
      TDD Courses
    </a> -->
    <a href="#" data-activates="mobile-demo" class="right button-collapse"><i class="material-icons">menu</i></a>
    <ul class="right hide-on-med-and-down">
      <li><a href="/">Course</a></li>
      <li><a href="/course-contents">Contents</a></li>
    </ul>
    <ul class="side-nav" id="mobile-demo">
      <li><a href="/">Home</a></li>
      <li><a href="/">Course</a></li>
      <li><a href="/course-contents">Contents</a></li>
    </ul>
  </div>
</nav>


    <br>

    <div class="container">
      <div class="row">

        <div class="col m3 hide-on-small-and-down">
  <br>
  <div id="toc-block" class="collection hide-on-small-and-down">
    <ul class="collapsible collapsible-accordion">
      
        
          <li>
            <h5 data-part="1" class="collapsible-header  waves-effect waves-teal">
              Part 1
            </h5>
            <div class="collapsible-body">
        
        <ul>
          <li class="collection-li">
            <span>1.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-one-intro">
                Introduction
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>2.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-one-microservices">
                Microservices
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>3.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-one-app-overview">
                App Overview
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>4.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-one-getting-started">
                Getting Started
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>5.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-one-docker-config">
                Docker Config
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>6.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-one-postgres-setup">
                Postgres Setup
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>7.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-one-test-setup">
                Test Setup
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>8.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-one-flask-blueprints">
                Flask Blueprints
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>9.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-one-restful-routes">
                RESTful Routes
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>10.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-one-deployment">
                Deployment
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>11.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-one-jinja-templates">
                Jinja Templates
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>12.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-one-workflow">
                Workflow
              </a>
            </span>
          </li>
        </ul>
      
        
          <li>
            <h5 data-part="2" class="collapsible-header  waves-effect waves-teal">
              Part 2
            </h5>
            <div class="collapsible-body">
        
        <ul>
          <li class="collection-li">
            <span>1.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-two-intro">
                Introduction
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>2.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-two-code-coverage-and-quality">
                Code Coverage and Quality
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>3.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-two-continuous-integration">
                Continuous Integration
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>4.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-two-react-setup">
                React Setup
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>5.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-two-testing-react">
                Testing React
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>6.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-two-react-forms">
                React Forms
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>7.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-two-react-and-docker">
                React and Docker
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>8.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-two-next-steps">
                Next Steps
              </a>
            </span>
          </li>
        </ul>
      
        
          <li>
            <h5 data-part="3" class="collapsible-header  waves-effect waves-teal">
              Part 3
            </h5>
            <div class="collapsible-body">
        
        <ul>
          <li class="collection-li">
            <span>1.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-three-into">
                Introduction
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>2.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-three-flask-migrate">
                Flask Migrate
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>3.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-three-flask-bcrypt">
                Flask Bcrypt
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>4.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-three-jwt-setup">
                JWT Setup
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>5.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-three-auth-routes">
                Auth Routes
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>6.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-three-react-router">
                React Router
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>7.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-three-react-bootstrap">
                React Bootstrap
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>8.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-three-react-auth-one">
                React Authentication - part one
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>9.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-three-mocking-user-interaction">
                Mocking User Interaction
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>10.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-three-react-auth-two">
                React Authentication - part two
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>11.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-three-authorization">
                Authorization
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>12.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-three-update-component">
                Update Component
              </a>
            </span>
          </li>
        </ul>
      
        
        <ul>
          <li class="collection-li">
            <span>13.&nbsp;</span>
            <span>
              <a class="collection-item" href="https://testdriven.io/part-three-update-docker">
                Update Docker
              </a>
            </span>
          </li>
        </ul>
      
    </div>
  </li>
    </ul>
  </div>
</div>


        <div class="col m9 hide-on-small-and-down">

          <h2>Flask Migrate</h2>

          
            <h5>Part 3, Lesson 2</h5>

            <div class="page-nav">
              
                <a class="prev btn left-align" href="https://testdriven.io/part-three-into">&laquo; Introduction</a>
              
              
                <a class="next btn right-align" href="https://testdriven.io/part-three-flask-bcrypt">Flask Bcrypt &raquo;</a>
              
            </div>

            
  <br>
  <a class="twitter-share-button" data-show-count="false" href="https://twitter.com/intent/tweet?text=Microservices with Docker, Flask, and React - Flask Migrate&amp;url=https%3A%2F%2Ftestdriven.io/part-three-flask-migrate&amp;via=testdrivenio" rel="nofollow" target="_blank" title="Share on Twitter"></a><script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>



            <br><br>

          

          <p>In this lesson, we&#39;ll utilize Flask Migrate to handle database migrations...</p>

<hr>

<p>Set <code>testdriven-dev</code> as the active Docker Machine:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span></span>$ docker-machine env testdriven-dev
$ <span class="nb">eval</span> <span class="k">$(</span>docker-machine env testdriven-dev<span class="k">)</span>
</code></pre></div>
<p>Update the containers:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span></span>$ docker-compose -f docker-compose-dev.yml up -d
</code></pre></div>
<p>Ensure the app is working in the browser, and then run the tests:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span></span>$ docker-compose -f docker-compose-dev.yml <span class="se">\</span>
  run users-service python manage.py <span class="nb">test</span>

$ docker-compose -f docker-compose-dev.yml <span class="se">\</span>
    run client npm <span class="nb">test</span>
</code></pre></div>
<h3 id="model">Model</h3>

<p>Let&#39;s make a few changes to the schema in <em>services/users/project/api/models.py</em>:</p>

<ol>
<li><code>username</code> must be unique</li>
<li><code>email</code> must be unique</li>
</ol>

<p>We&#39;ll also add a password field (in an upcoming lesson), which will be hashed before it&#39;s added to the database:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="n">password</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div>
<p>Don&#39;t make any changes just yet. Let&#39;s start with some tests. Add a new file to &quot;services/users/project/tests&quot; called <em>test_user_model.py</em>. This file will hold tests related to our database model:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="c1"># users/project/tests/test_user_model.py</span>


<span class="kn">from</span> <span class="nn">project</span> <span class="kn">import</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">project.api.models</span> <span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span> <span class="nn">project.tests.base</span> <span class="kn">import</span> <span class="n">BaseTestCase</span>


<span class="k">class</span> <span class="nc">TestUserModel</span><span class="p">(</span><span class="n">BaseTestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_add_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
            <span class="n">username</span><span class="o">=</span><span class="s1">&#39;justatest&#39;</span><span class="p">,</span>
            <span class="n">email</span><span class="o">=</span><span class="s1">&#39;test@test.com&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s1">&#39;justatest&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="s1">&#39;test@test.com&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">active</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_add_user_duplicate_username</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
            <span class="n">username</span><span class="o">=</span><span class="s1">&#39;justatest&#39;</span><span class="p">,</span>
            <span class="n">email</span><span class="o">=</span><span class="s1">&#39;test@test.com&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">duplicate_user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
            <span class="n">username</span><span class="o">=</span><span class="s1">&#39;justatest&#39;</span><span class="p">,</span>
            <span class="n">email</span><span class="o">=</span><span class="s1">&#39;test@test2.com&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">duplicate_user</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">IntegrityError</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_add_user_duplicate_email</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
            <span class="n">username</span><span class="o">=</span><span class="s1">&#39;justatest&#39;</span><span class="p">,</span>
            <span class="n">email</span><span class="o">=</span><span class="s1">&#39;test@test.com&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">duplicate_user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
            <span class="n">username</span><span class="o">=</span><span class="s1">&#39;justanothertest&#39;</span><span class="p">,</span>
            <span class="n">email</span><span class="o">=</span><span class="s1">&#39;test@test.com&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">duplicate_user</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">IntegrityError</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">add_user</span><span class="p">(</span><span class="s1">&#39;justatest&#39;</span><span class="p">,</span> <span class="s1">&#39;test@test.com&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">to_json</span><span class="p">(),</span> <span class="nb">dict</span><span class="p">))</span>
</code></pre></div>
<p>Notice how we didn&#39;t invoke <code>db.session.commit</code> the second time, when adding a user. Instead, we passed it to <code>assertRaises()</code> and let it invoke it and assert the exception was raised.</p>

<p>Add the import:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.exc</span> <span class="kn">import</span> <span class="n">IntegrityError</span>
</code></pre></div>
<p>Run the tests. You should see two failures:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span></span>test_add_user_duplicate_email <span class="o">(</span>test_user_model.TestUserModel<span class="o">)</span> ... FAIL
test_add_user_duplicate_username <span class="o">(</span>test_user_model.TestUserModel<span class="o">)</span> ... FAIL
</code></pre></div>
<p>Error:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span></span>AssertionError: IntegrityError not raised by <span class="k">do</span>
</code></pre></div>
<h3 id="flask-migrate-setup">Flask Migrate Setup</h3>

<p>Since we need to make a schema change, add <a href="https://flask-migrate.readthedocs.io/en/latest/">Flask-Migrate</a> to the <em>requirements.txt</em> file:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text"><span></span>flask-migrate==2.1.1
</code></pre></div>
<p>In <em>services/users/project/__init__.py</em>, add the import, create a new instance, and update <code>create_app()</code>:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="c1"># users/project/__init__.py</span>


<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">flask_cors</span> <span class="kn">import</span> <span class="n">CORS</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">flask_sqlalchemy</span> <span class="kn">import</span> <span class="n">SQLAlchemy</span>
<span class="kn">from</span> <span class="nn">flask_migrate</span> <span class="kn">import</span> <span class="n">Migrate</span>


<span class="c1"># instantiate the db</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">()</span>
<span class="c1"># instantiate flask migrate</span>
<span class="n">migrate</span> <span class="o">=</span> <span class="n">Migrate</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">create_app</span><span class="p">():</span>

    <span class="c1"># instantiate the app</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="c1"># enable CORS</span>
    <span class="n">CORS</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

    <span class="c1"># set config</span>
    <span class="n">app_settings</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;APP_SETTINGS&#39;</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="n">app_settings</span><span class="p">)</span>

    <span class="c1"># set up extensions</span>
    <span class="n">db</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">migrate</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>

    <span class="c1"># register blueprints</span>
    <span class="kn">from</span> <span class="nn">project.api.users</span> <span class="kn">import</span> <span class="n">users_blueprint</span>
    <span class="n">app</span><span class="o">.</span><span class="n">register_blueprint</span><span class="p">(</span><span class="n">users_blueprint</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">app</span>
</code></pre></div>
<p>Then, add a new manager command to <em>services/users/manage.py</em>, just below <code>manager = Manager(app)</code>:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="n">manager</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="s1">&#39;db&#39;</span><span class="p">,</span> <span class="n">MigrateCommand</span><span class="p">)</span>
</code></pre></div>
<p>Add the import as well:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="kn">from</span> <span class="nn">flask_migrate</span> <span class="kn">import</span> <span class="n">MigrateCommand</span>
</code></pre></div>
<p>Update the containers:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span></span>$ docker-compose -f docker-compose-dev.yml up -d --build
</code></pre></div>
<p>Generate the migrations folder, add the initial migration, and then apply it to the database:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span></span>$ docker-compose -f docker-compose-dev.yml <span class="se">\</span>
  run users-service python manage.py db init

$ docker-compose -f docker-compose-dev.yml <span class="se">\</span>
  run users-service python manage.py db migrate

$ docker-compose -f docker-compose-dev.yml <span class="se">\</span>
  run users-service python manage.py db upgrade
</code></pre></div>
<blockquote>
<p>Review the <a href="https://flask-migrate.readthedocs.io/en/latest/">Flask-Migrate documentation</a> for more info on the above commands.</p>
</blockquote>

<p>Now, we can make the changes to the schema:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;users&quot;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">active</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div>
<p>Again, run:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span></span>$ docker-compose -f docker-compose-dev.yml <span class="se">\</span>
  run users-service python manage.py db migrate

$ docker-compose -f docker-compose-dev.yml <span class="se">\</span>
  run users-service python manage.py db upgrade
</code></pre></div>
<blockquote>
<p>Keep in mind that if you have any duplicate usernames and/or emails already in your database, you will get an error when trying to apply the migration to the database. You can either update the data or drop the db and start over.</p>
</blockquote>

<p>Run the tests again. They should pass!</p>

<h3 id="refactor">Refactor</h3>

<p>Now is a good time to do some refactoring...</p>

<p>First, in <em>services/users/project/tests/test_users.pyy</em>, rename <code>test_add_user_duplicate_user</code> to <code>test_add_user_duplicate_email</code>.</p>

<p>Also, did you notice that we added a new user a number of times in the <em>test_user_model.py</em> tests? Let&#39;s abstract out the <code>add_user</code> helper function from <em>test_users.py</em> to a utility file so we can use it in both test files.</p>

<p>Add a new file called <em>utils.py</em> to &quot;tests&quot;:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="c1"># users/project/tests/utils.py</span>


<span class="kn">from</span> <span class="nn">project</span> <span class="kn">import</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">project.api.models</span> <span class="kn">import</span> <span class="n">User</span>


<span class="k">def</span> <span class="nf">add_user</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">user</span>
</code></pre></div>
<p>Then remove the helper from <em>test_users.py</em> and add the import to the same file:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="kn">from</span> <span class="nn">project.tests.utils</span> <span class="kn">import</span> <span class="n">add_user</span>
</code></pre></div>
<p>Refactor <em>test_user_model.py</em> like so:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="c1"># users/project/tests/test_user_model.py</span>


<span class="kn">from</span> <span class="nn">sqlalchemy.exc</span> <span class="kn">import</span> <span class="n">IntegrityError</span>

<span class="kn">from</span> <span class="nn">project</span> <span class="kn">import</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">project.api.models</span> <span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span> <span class="nn">project.tests.base</span> <span class="kn">import</span> <span class="n">BaseTestCase</span>
<span class="kn">from</span> <span class="nn">project.tests.utils</span> <span class="kn">import</span> <span class="n">add_user</span>


<span class="k">class</span> <span class="nc">TestUserModel</span><span class="p">(</span><span class="n">BaseTestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_add_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">add_user</span><span class="p">(</span><span class="s1">&#39;justatest&#39;</span><span class="p">,</span> <span class="s1">&#39;test@test.com&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s1">&#39;justatest&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="s1">&#39;test@test.com&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">active</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_add_user_duplicate_username</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">add_user</span><span class="p">(</span><span class="s1">&#39;justatest&#39;</span><span class="p">,</span> <span class="s1">&#39;test@test.com&#39;</span><span class="p">)</span>
        <span class="n">duplicate_user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
            <span class="n">username</span><span class="o">=</span><span class="s1">&#39;justatest&#39;</span><span class="p">,</span>
            <span class="n">email</span><span class="o">=</span><span class="s1">&#39;test@test2.com&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">duplicate_user</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">IntegrityError</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_add_user_duplicate_email</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">add_user</span><span class="p">(</span><span class="s1">&#39;justatest&#39;</span><span class="p">,</span> <span class="s1">&#39;test@test.com&#39;</span><span class="p">)</span>
        <span class="n">duplicate_user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
            <span class="n">username</span><span class="o">=</span><span class="s1">&#39;justatest2&#39;</span><span class="p">,</span>
            <span class="n">email</span><span class="o">=</span><span class="s1">&#39;test@test.com&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">duplicate_user</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">IntegrityError</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">add_user</span><span class="p">(</span><span class="s1">&#39;justatest&#39;</span><span class="p">,</span> <span class="s1">&#39;test@test.com&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">to_json</span><span class="p">(),</span> <span class="nb">dict</span><span class="p">))</span>
</code></pre></div>
<p>Run the tests again to ensure nothing broke from the refactor. What about flake8?</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span></span>$ docker-compose -f docker-compose-dev.yml <span class="se">\</span>
  run users-service flake8 project
</code></pre></div>
<p>Correct any issues, and then commit and push your code to GitHub. Make sure the Travis build passes.</p>


          <div class="page-nav">
            
              <a class="prev btn left-align" href="https://testdriven.io/part-three-into">&laquo; Introduction</a>
            
            
              <a class="next btn right-align" href="https://testdriven.io/part-three-flask-bcrypt">Flask Bcrypt &raquo;</a>
            
          </div>

          
  <br>
  <a class="twitter-share-button" data-show-count="false" href="https://twitter.com/intent/tweet?text=Microservices with Docker, Flask, and React - Flask Migrate&amp;url=https%3A%2F%2Ftestdriven.io/part-three-flask-migrate&amp;via=testdrivenio" rel="nofollow" target="_blank" title="Share on Twitter"></a><script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>



        </div>

        <div class="hide-on-med-and-up">

          <h2>Flask Migrate</h2>

          <p>In this lesson, we&#39;ll utilize Flask Migrate to handle database migrations...</p>

<hr>

<p>Set <code>testdriven-dev</code> as the active Docker Machine:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span></span>$ docker-machine env testdriven-dev
$ <span class="nb">eval</span> <span class="k">$(</span>docker-machine env testdriven-dev<span class="k">)</span>
</code></pre></div>
<p>Update the containers:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span></span>$ docker-compose -f docker-compose-dev.yml up -d
</code></pre></div>
<p>Ensure the app is working in the browser, and then run the tests:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span></span>$ docker-compose -f docker-compose-dev.yml <span class="se">\</span>
  run users-service python manage.py <span class="nb">test</span>

$ docker-compose -f docker-compose-dev.yml <span class="se">\</span>
    run client npm <span class="nb">test</span>
</code></pre></div>
<h3 id="model">Model</h3>

<p>Let&#39;s make a few changes to the schema in <em>services/users/project/api/models.py</em>:</p>

<ol>
<li><code>username</code> must be unique</li>
<li><code>email</code> must be unique</li>
</ol>

<p>We&#39;ll also add a password field (in an upcoming lesson), which will be hashed before it&#39;s added to the database:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="n">password</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div>
<p>Don&#39;t make any changes just yet. Let&#39;s start with some tests. Add a new file to &quot;services/users/project/tests&quot; called <em>test_user_model.py</em>. This file will hold tests related to our database model:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="c1"># users/project/tests/test_user_model.py</span>


<span class="kn">from</span> <span class="nn">project</span> <span class="kn">import</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">project.api.models</span> <span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span> <span class="nn">project.tests.base</span> <span class="kn">import</span> <span class="n">BaseTestCase</span>


<span class="k">class</span> <span class="nc">TestUserModel</span><span class="p">(</span><span class="n">BaseTestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_add_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
            <span class="n">username</span><span class="o">=</span><span class="s1">&#39;justatest&#39;</span><span class="p">,</span>
            <span class="n">email</span><span class="o">=</span><span class="s1">&#39;test@test.com&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s1">&#39;justatest&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="s1">&#39;test@test.com&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">active</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_add_user_duplicate_username</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
            <span class="n">username</span><span class="o">=</span><span class="s1">&#39;justatest&#39;</span><span class="p">,</span>
            <span class="n">email</span><span class="o">=</span><span class="s1">&#39;test@test.com&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">duplicate_user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
            <span class="n">username</span><span class="o">=</span><span class="s1">&#39;justatest&#39;</span><span class="p">,</span>
            <span class="n">email</span><span class="o">=</span><span class="s1">&#39;test@test2.com&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">duplicate_user</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">IntegrityError</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_add_user_duplicate_email</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
            <span class="n">username</span><span class="o">=</span><span class="s1">&#39;justatest&#39;</span><span class="p">,</span>
            <span class="n">email</span><span class="o">=</span><span class="s1">&#39;test@test.com&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">duplicate_user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
            <span class="n">username</span><span class="o">=</span><span class="s1">&#39;justanothertest&#39;</span><span class="p">,</span>
            <span class="n">email</span><span class="o">=</span><span class="s1">&#39;test@test.com&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">duplicate_user</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">IntegrityError</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">add_user</span><span class="p">(</span><span class="s1">&#39;justatest&#39;</span><span class="p">,</span> <span class="s1">&#39;test@test.com&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">to_json</span><span class="p">(),</span> <span class="nb">dict</span><span class="p">))</span>
</code></pre></div>
<p>Notice how we didn&#39;t invoke <code>db.session.commit</code> the second time, when adding a user. Instead, we passed it to <code>assertRaises()</code> and let it invoke it and assert the exception was raised.</p>

<p>Add the import:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.exc</span> <span class="kn">import</span> <span class="n">IntegrityError</span>
</code></pre></div>
<p>Run the tests. You should see two failures:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span></span>test_add_user_duplicate_email <span class="o">(</span>test_user_model.TestUserModel<span class="o">)</span> ... FAIL
test_add_user_duplicate_username <span class="o">(</span>test_user_model.TestUserModel<span class="o">)</span> ... FAIL
</code></pre></div>
<p>Error:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span></span>AssertionError: IntegrityError not raised by <span class="k">do</span>
</code></pre></div>
<h3 id="flask-migrate-setup">Flask Migrate Setup</h3>

<p>Since we need to make a schema change, add <a href="https://flask-migrate.readthedocs.io/en/latest/">Flask-Migrate</a> to the <em>requirements.txt</em> file:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text"><span></span>flask-migrate==2.1.1
</code></pre></div>
<p>In <em>services/users/project/__init__.py</em>, add the import, create a new instance, and update <code>create_app()</code>:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="c1"># users/project/__init__.py</span>


<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">flask_cors</span> <span class="kn">import</span> <span class="n">CORS</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">flask_sqlalchemy</span> <span class="kn">import</span> <span class="n">SQLAlchemy</span>
<span class="kn">from</span> <span class="nn">flask_migrate</span> <span class="kn">import</span> <span class="n">Migrate</span>


<span class="c1"># instantiate the db</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">()</span>
<span class="c1"># instantiate flask migrate</span>
<span class="n">migrate</span> <span class="o">=</span> <span class="n">Migrate</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">create_app</span><span class="p">():</span>

    <span class="c1"># instantiate the app</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="c1"># enable CORS</span>
    <span class="n">CORS</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

    <span class="c1"># set config</span>
    <span class="n">app_settings</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;APP_SETTINGS&#39;</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="n">app_settings</span><span class="p">)</span>

    <span class="c1"># set up extensions</span>
    <span class="n">db</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">migrate</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>

    <span class="c1"># register blueprints</span>
    <span class="kn">from</span> <span class="nn">project.api.users</span> <span class="kn">import</span> <span class="n">users_blueprint</span>
    <span class="n">app</span><span class="o">.</span><span class="n">register_blueprint</span><span class="p">(</span><span class="n">users_blueprint</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">app</span>
</code></pre></div>
<p>Then, add a new manager command to <em>services/users/manage.py</em>, just below <code>manager = Manager(app)</code>:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="n">manager</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="s1">&#39;db&#39;</span><span class="p">,</span> <span class="n">MigrateCommand</span><span class="p">)</span>
</code></pre></div>
<p>Add the import as well:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="kn">from</span> <span class="nn">flask_migrate</span> <span class="kn">import</span> <span class="n">MigrateCommand</span>
</code></pre></div>
<p>Update the containers:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span></span>$ docker-compose -f docker-compose-dev.yml up -d --build
</code></pre></div>
<p>Generate the migrations folder, add the initial migration, and then apply it to the database:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span></span>$ docker-compose -f docker-compose-dev.yml <span class="se">\</span>
  run users-service python manage.py db init

$ docker-compose -f docker-compose-dev.yml <span class="se">\</span>
  run users-service python manage.py db migrate

$ docker-compose -f docker-compose-dev.yml <span class="se">\</span>
  run users-service python manage.py db upgrade
</code></pre></div>
<blockquote>
<p>Review the <a href="https://flask-migrate.readthedocs.io/en/latest/">Flask-Migrate documentation</a> for more info on the above commands.</p>
</blockquote>

<p>Now, we can make the changes to the schema:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;users&quot;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">active</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div>
<p>Again, run:</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span></span>$ docker-compose -f docker-compose-dev.yml <span class="se">\</span>
  run users-service python manage.py db migrate

$ docker-compose -f docker-compose-dev.yml <span class="se">\</span>
  run users-service python manage.py db upgrade
</code></pre></div>
<blockquote>
<p>Keep in mind that if you have any duplicate usernames and/or emails already in your database, you will get an error when trying to apply the migration to the database. You can either update the data or drop the db and start over.</p>
</blockquote>

<p>Run the tests again. They should pass!</p>

<h3 id="refactor">Refactor</h3>

<p>Now is a good time to do some refactoring...</p>

<p>First, in <em>services/users/project/tests/test_users.pyy</em>, rename <code>test_add_user_duplicate_user</code> to <code>test_add_user_duplicate_email</code>.</p>

<p>Also, did you notice that we added a new user a number of times in the <em>test_user_model.py</em> tests? Let&#39;s abstract out the <code>add_user</code> helper function from <em>test_users.py</em> to a utility file so we can use it in both test files.</p>

<p>Add a new file called <em>utils.py</em> to &quot;tests&quot;:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="c1"># users/project/tests/utils.py</span>


<span class="kn">from</span> <span class="nn">project</span> <span class="kn">import</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">project.api.models</span> <span class="kn">import</span> <span class="n">User</span>


<span class="k">def</span> <span class="nf">add_user</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">user</span>
</code></pre></div>
<p>Then remove the helper from <em>test_users.py</em> and add the import to the same file:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="kn">from</span> <span class="nn">project.tests.utils</span> <span class="kn">import</span> <span class="n">add_user</span>
</code></pre></div>
<p>Refactor <em>test_user_model.py</em> like so:</p>
<div class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="c1"># users/project/tests/test_user_model.py</span>


<span class="kn">from</span> <span class="nn">sqlalchemy.exc</span> <span class="kn">import</span> <span class="n">IntegrityError</span>

<span class="kn">from</span> <span class="nn">project</span> <span class="kn">import</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">project.api.models</span> <span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span> <span class="nn">project.tests.base</span> <span class="kn">import</span> <span class="n">BaseTestCase</span>
<span class="kn">from</span> <span class="nn">project.tests.utils</span> <span class="kn">import</span> <span class="n">add_user</span>


<span class="k">class</span> <span class="nc">TestUserModel</span><span class="p">(</span><span class="n">BaseTestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_add_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">add_user</span><span class="p">(</span><span class="s1">&#39;justatest&#39;</span><span class="p">,</span> <span class="s1">&#39;test@test.com&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s1">&#39;justatest&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="s1">&#39;test@test.com&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">active</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_add_user_duplicate_username</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">add_user</span><span class="p">(</span><span class="s1">&#39;justatest&#39;</span><span class="p">,</span> <span class="s1">&#39;test@test.com&#39;</span><span class="p">)</span>
        <span class="n">duplicate_user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
            <span class="n">username</span><span class="o">=</span><span class="s1">&#39;justatest&#39;</span><span class="p">,</span>
            <span class="n">email</span><span class="o">=</span><span class="s1">&#39;test@test2.com&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">duplicate_user</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">IntegrityError</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_add_user_duplicate_email</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">add_user</span><span class="p">(</span><span class="s1">&#39;justatest&#39;</span><span class="p">,</span> <span class="s1">&#39;test@test.com&#39;</span><span class="p">)</span>
        <span class="n">duplicate_user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span>
            <span class="n">username</span><span class="o">=</span><span class="s1">&#39;justatest2&#39;</span><span class="p">,</span>
            <span class="n">email</span><span class="o">=</span><span class="s1">&#39;test@test.com&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">duplicate_user</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">IntegrityError</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">add_user</span><span class="p">(</span><span class="s1">&#39;justatest&#39;</span><span class="p">,</span> <span class="s1">&#39;test@test.com&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">to_json</span><span class="p">(),</span> <span class="nb">dict</span><span class="p">))</span>
</code></pre></div>
<p>Run the tests again to ensure nothing broke from the refactor. What about flake8?</p>
<div class="highlight"><pre><code class="language-sh" data-lang="sh"><span></span>$ docker-compose -f docker-compose-dev.yml <span class="se">\</span>
  run users-service flake8 project
</code></pre></div>
<p>Correct any issues, and then commit and push your code to GitHub. Make sure the Travis build passes.</p>


          
  <br>
  <a class="twitter-share-button" data-show-count="false" href="https://twitter.com/intent/tweet?text=Microservices with Docker, Flask, and React - Flask Migrate&amp;url=https%3A%2F%2Ftestdriven.io/part-three-flask-migrate&amp;via=testdrivenio" rel="nofollow" target="_blank" title="Share on Twitter"></a><script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>



          <div class="page-nav">
            
              <a class="prev btn left-align" href="https://testdriven.io/part-three-into">&laquo; Introduction</a>
            
            
              <a class="next btn right-align" href="https://testdriven.io/part-three-flask-bcrypt">Flask Bcrypt &raquo;</a>
            
          </div>

        </div>

      </div>
    </div>

     <footer class="page-footer white">
  <div class="container footer-container center-align">
    <ul>
      <li><small>Content by Michael Herman (michael@mherman.org)</small></li>
      <li><small>&copy; Copyright 2017 <a href="http://testdriven.io">TestDriven.io</a></small></li>
    </ul>
  </div>
</footer>


    <script type="text/javascript" src="//code.jquery.com/jquery-2.1.1.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/js/materialize.min.js"></script>

    
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-100160465-1', 'auto');
    ga('send', 'pageview');

  </script>



  </body>
</html>
